<div 
  class="min-h-screen bg-gray-50"
  data-controller="dashboard"
>
  <!-- Header -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Financial Advisor AI Assistant</h1>
          <p class="text-gray-600">Manage your clients, emails, calendar, and tasks with AI assistance</p>
        </div>
        
        <!-- Chat Button -->
        <button 
          data-action="click->dashboard#openModal"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 font-medium transition-colors cursor-pointer"
        >
          <%= inline_svg "icons/bot.svg", class: "w-5 h-5" %>
          Open AI Chat
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- User Info & Quick Actions -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center">
            <span class="text-white text-xl font-bold">
              <%= @user.first_name&.first&.upcase || @user.email_address&.first&.upcase %>
            </span>
          </div>
          <div>
            <h2 class="text-xl font-semibold text-gray-900">
              <%= [@user.first_name, @user.last_name].compact.join(' ').presence || 'User' %>
            </h2>
            <p class="text-gray-600"><%= @user.email_address %></p>
            <p class="text-sm text-gray-500">
              Member since <%= @user.created_at.strftime("%B %Y") %>
            </p>
          </div>
        </div>
        
        <!-- Logout Button -->
        <%= button_to session_path, method: :delete, class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors cursor-pointer" do %>
          <%= inline_svg "icons/logout.svg", class: "w-4 h-4" %>
          Sign Out
        <% end %>
      </div>

    </div>

    <!-- Pull Latest Data Action -->
    <% if @google_connected || @hubspot_connected %>
      <%= button_to pull_data_path, method: :post, class: "w-full bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg flex items-center justify-center gap-3 transition-colors cursor-pointer mb-8" do %>
        <%= inline_svg "icons/download.svg", class: "w-6 h-6" %>
        <div class="text-center">
          <div class="font-medium text-lg">Pull Latest Data</div>
          <div class="text-sm opacity-90">Sync from Google & HubSpot</div>
        </div>
      <% end %>
    <% else %>
      <div class="w-full bg-gray-100 border border-gray-200 text-gray-500 p-4 rounded-lg flex items-center justify-center gap-3 mb-8">
        <%= inline_svg "icons/download.svg", class: "w-6 h-6" %>
        <div class="text-center">
          <div class="font-medium text-lg">Pull Latest Data</div>
          <div class="text-sm">Connect accounts first</div>
        </div>
      </div>
    <% end %>

    <!-- Data Sections -->
    <div class="space-y-6">
      <!-- Google Account Section -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <%= inline_svg "icons/google.svg", class: "w-8 h-8" %>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">Google Account</h3>
                <p class="text-sm text-gray-600">Gmail & Calendar integration</p>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <% if @google_connected %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Connected
                </span>
                <%= button_to disconnect_google_path, method: :delete, class: "text-red-600 hover:text-red-700 text-sm font-medium cursor-pointer" do %>
                  Disconnect
                <% end %>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  Not Connected
                </span>
                <%= link_to "/auth/google_oauth2", class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer" do %>
                  Connect Google
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <% if @google_connected %>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Recent Emails -->
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h4 class="font-medium text-gray-900">Recent Emails (<%= @stats[:emails] %> total)</h4>
                  <%= button_to import_google_emails_path, method: :post, class: "text-blue-600 hover:text-blue-700 text-sm font-medium cursor-pointer" do %>
                    Import Now
                  <% end %>
                </div>
                <div class="space-y-2">
                  <% if @recent_emails.any? %>
                    <% @recent_emails.each do |email| %>
                      <div class="text-sm p-3 bg-gray-50 rounded">
                        <div class="font-medium text-gray-900 truncate"><%= email.subject %></div>
                        <div class="text-gray-600 text-xs">From: <%= email.from_email %></div>
                        <div class="text-gray-500 text-xs"><%= time_ago_in_words(email.received_at) %> ago</div>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="text-gray-500 text-sm italic">No emails imported yet</div>
                  <% end %>
                </div>
              </div>

              <!-- Upcoming Calendar Events -->
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h4 class="font-medium text-gray-900">Upcoming Events (<%= @stats[:calendar_events] %> total)</h4>
                  <%= button_to import_google_calendar_path, method: :post, class: "text-blue-600 hover:text-blue-700 text-sm font-medium cursor-pointer" do %>
                    Import Now
                  <% end %>
                </div>
                <div class="space-y-2">
                  <% if @upcoming_events.any? %>
                    <% @upcoming_events.each do |event| %>
                      <div class="text-sm p-3 bg-gray-50 rounded">
                        <div class="font-medium text-gray-900 truncate"><%= event.title %></div>
                        <div class="text-gray-600 text-xs">
                          <%= event.start_time.strftime("%b %d, %Y at %I:%M %p") %>
                        </div>
                        <% if event.location.present? %>
                          <div class="text-gray-500 text-xs">üìç <%= event.location %></div>
                        <% end %>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="text-gray-500 text-sm italic">No upcoming events</div>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- HubSpot Section -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <%= inline_svg "icons/users.svg", class: "w-8 h-8" %>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">HubSpot CRM</h3>
                <p class="text-sm text-gray-600">Customer relationship management</p>
              </div>
            </div>
            <div class="flex items-center gap-4">
              <% if @hubspot_connected %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Connected
                </span>
                <%= button_to disconnect_hubspot_path, method: :delete, class: "text-red-600 hover:text-red-700 text-sm font-medium cursor-pointer" do %>
                  Disconnect
                <% end %>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  Not Connected
                </span>
                <%= button_to "/auth/hubspot", method: :post, data: {turbo: false}, class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer" do %>
                  Connect HubSpot
                <% end %>
              <% end %>
            </div>
          </div>
        </div>

        <% if @hubspot_connected %>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Recent Contacts -->
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h4 class="font-medium text-gray-900">Recent Contacts (<%= @stats[:hubspot_contacts] %> total)</h4>
                  <%= button_to import_hubspot_contacts_path, method: :post, class: "text-blue-600 hover:text-blue-700 text-sm font-medium cursor-pointer" do %>
                    Import Now
                  <% end %>
                </div>
                <div class="space-y-2">
                  <% if @recent_contacts.any? %>
                    <% @recent_contacts.each do |contact| %>
                      <div class="text-sm p-3 bg-gray-50 rounded">
                        <div class="font-medium text-gray-900">
                          <%= [contact.first_name, contact.last_name].compact.join(' ') %>
                        </div>
                        <% if contact.email.present? %>
                          <div class="text-gray-600 text-xs">üìß <%= contact.email %></div>
                        <% end %>
                        <% if contact.company.present? %>
                          <div class="text-gray-500 text-xs">üè¢ <%= contact.company %></div>
                        <% end %>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="text-gray-500 text-sm italic">No contacts imported yet</div>
                  <% end %>
                </div>
              </div>

              <!-- Notes Summary -->
              <div>
                <div class="flex items-center justify-between mb-4">
                  <h4 class="font-medium text-gray-900">Notes (<%= @stats[:hubspot_notes] %> total)</h4>
                  <%= button_to import_hubspot_notes_path, method: :post, class: "text-blue-600 hover:text-blue-700 text-sm font-medium cursor-pointer" do %>
                    Import Now
                  <% end %>
                </div>
                <div class="text-sm text-gray-600">
                  <p>üìù Total notes: <%= @stats[:hubspot_notes] %></p>
                  <p class="text-xs text-gray-500 mt-2">Notes are imported and processed for AI context</p>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Tasks Section -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <%= inline_svg "icons/check.svg", class: "w-8 h-8" %>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">Tasks</h3>
                <p class="text-sm text-gray-600">AI-created and user tasks</p>
              </div>
            </div>
            <div class="text-sm text-gray-600">
              <%= @stats[:pending_tasks] %> pending, <%= @stats[:tasks] %> total
            </div>
          </div>
        </div>

        <div class="p-6">
          <div class="space-y-2">
            <% if @pending_tasks.any? %>
              <% @pending_tasks.each do |task| %>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                  <div class="flex-1">
                    <div class="font-medium text-gray-900"><%= task.title %></div>
                    <% if task.description.present? %>
                      <div class="text-sm text-gray-600"><%= task.description.truncate(100) %></div>
                    <% end %>
                    <div class="text-xs text-gray-500 mt-1">
                      Priority: <%= task.priority.capitalize %>
                      <% if task.due_date %>
                        ‚Ä¢ Due: <%= task.due_date.strftime("%b %d, %Y") %>
                      <% end %>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      <%= task.status.humanize %>
                    </span>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-gray-500 text-sm italic text-center py-8">
                No pending tasks. Create some tasks by chatting with the AI!
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Activity Logs Section -->
      <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center gap-3">
            <%= inline_svg "icons/clipboard.svg", class: "w-8 h-8" %>
            <div>
              <h3 class="text-lg font-semibold text-gray-900">AI Activity Logs</h3>
              <p class="text-sm text-gray-600">Recent tool executions and actions</p>
            </div>
          </div>
        </div>

        <div class="divide-y divide-gray-200">
          <% if @recent_action_logs.any? %>
            <% @recent_action_logs.each do |log| %>
              <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-gray-900"><%= log.tool_name %></span>
                      <% if log.result&.dig("success") %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          Success
                        </span>
                      <% else %>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                          Failed
                        </span>
                      <% end %>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                      <%= time_ago_in_words(log.created_at) %> ago
                    </div>
                    <% if log.result&.dig("message") %>
                      <div class="text-xs text-gray-500 mt-1">
                        <%= log.result["message"].truncate(100) %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="px-6 py-8 text-center text-gray-500 text-sm italic">
              No AI activity yet. Start chatting to see tool executions here!
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </main>

  <!-- Chat Popup Modal (initially hidden) -->
  <div 
    data-dashboard-target="modal"
    class="fixed inset-0 z-50 hidden" 
    style="overflow: hidden;"
  >
    <!-- Backdrop -->
    <div 
      data-dashboard-target="backdrop"
      data-action="click->dashboard#closeModal"
      class="fixed inset-0 bg-black/20 cursor-pointer"
    ></div>
    
    <!-- Modal -->
    <div class="fixed inset-4 md:inset-8 lg:inset-16 bg-white/95 backdrop-blur-sm rounded-lg shadow-xl" style="display: flex; flex-direction: column; overflow: hidden; max-height: calc(100vh - 64px);">
      <!-- Chat content will be loaded here -->
      <div 
        data-dashboard-target="content"
        style="flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%;"
      >
        <!-- Loading state -->
        <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
          <div style="color: #6b7280;">Loading chat...</div>
        </div>
      </div>
    </div>
  </div>
</div>

